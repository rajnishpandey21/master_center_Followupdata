<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Master KPI Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { margin:0; font-family:'Poppins', sans-serif; background:#f4f7f6; color: #333; }
    .header { background:#1434A4; color: white; padding:15px 30px; font-weight:700; font-size: 1.2rem; display:flex; justify-content:space-between; align-items: center; }
    .wrap { padding:20px; max-width:1600px; margin:0 auto; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:20px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .controls select, .controls input { padding:10px; border:1px solid #ccc; border-radius:6px; font-family:'Poppins', sans-serif; background: #fff; }
    .btn { padding:10px 18px; color:#fff; border:none; font-weight:700; cursor:pointer; border-radius: 9999px; transition: background 0.2s, transform 0.1s; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    .btn.primary { background:#1434A4; }
    .btn.primary:hover { background:#0F2C81; transform: translateY(-1px); }
    .btn.export { background:#1D6F42; }
    .btn.export:hover { background:#165934; transform: translateY(-1px); }
    .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
    .kpi-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; }
    .card { background:#fff; border-radius:8px; padding:20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .card .title { font-size: 1rem; color: #555; margin-bottom: 10px; }
    .card .value { font-size: 2.5rem; font-weight: 700; color: #1434A4; }
    .card .subtext { font-size: 0.8rem; color: #777; margin-top:5px;}
    h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 40px; color: #1434A4;}
    .status { font-weight: 600; margin-left: 15px; }
    #reportDetails { margin-top: 20px; }
    .day-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-bottom: 15px; }
    .day-header { font-weight: 700; font-size: 1.2rem; margin-bottom: 10px; }
    .disposition-table { width: 100%; border-collapse: collapse; margin-top:10px; }
    .disposition-table th, .disposition-table td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <div class="header">
    <div>Admin - Master KPI Tracker</div>
    <div id="counselorNameDisplay"></div>
  </div>
  <div class="wrap">
    <div class="controls">
      <select id="centerSelect" required><option value="">Select Center...</option></select>
      <select id="counselorSelect" required disabled><option value="">Select Counselor...</option></select>
      <input type="date" id="from" />
      <input type="date" id="to" />
      <button class="btn primary" id="btnRun" disabled>Run Report</button>
      <button class="btn export" id="btnExportMaster">Export Master Data</button>
      <div id="status" class="status"></div>
    </div>

    <h2>High-Level Summary</h2>
    <div class="kpi-grid" id="summary-kpis">
        <p>Please select a center and counselor to view summary data.</p>
    </div>

    <h2 id="details-header">Daily Breakup</h2>
    <div id="reportDetails"></div>
  </div>

<script>
    (function(){
      var API_BASE = 'https://script.google.com/macros/s/AKfycbwguUkMt32RtWsIvBODnHo0HZEF-3B8CD0TCdzq8utulDQfQSkUlzX8FUCHZJMwuO6Wow/exec';

      var centerSelect = document.getElementById('centerSelect');
      var counselorSelect = document.getElementById('counselorSelect');
      var fromEl = document.getElementById('from');
      var toEl = document.getElementById('to');
      var btnRun = document.getElementById('btnRun');
      var btnExportMaster = document.getElementById('btnExportMaster');
      var statusEl = document.getElementById('status');
      var reportDetailsEl = document.getElementById('reportDetails');
      var summaryKpisEl = document.getElementById('summary-kpis');
      var counselorNameDisplay = document.getElementById('counselorNameDisplay');

      function fetchJson(url) {
        statusEl.textContent = 'Loading...';
        btnRun.disabled = true;
        return fetch(url).then(r => {
            if (!r.ok) throw new Error(`Network response was not ok (${r.status})`);
            return r.json();
        }).finally(() => {
          statusEl.textContent = '';
          validateControls();
        });
      }

      function populateCenters() {
        fetchJson(API_BASE + '?action=getcenters').then(data => {
          if (data.ok && data.centers) {
            centerSelect.innerHTML = '<option value="">Select Center...</option>';
            data.centers.sort().forEach(center => centerSelect.add(new Option(center, center)));
          }
        }).catch(() => statusEl.textContent = 'Error loading centers.');
      }

      centerSelect.addEventListener('change', function() {
        var center = this.value;
        counselorSelect.innerHTML = '<option value="">Loading...</option>';
        counselorSelect.disabled = true;
        if (!center) {
          counselorSelect.innerHTML = '<option value="">Select Counselor...</option>';
          validateControls();
          return;
        }
        fetchJson(`${API_BASE}?action=getcounselors&center=${encodeURIComponent(center)}`).then(data => {
          if (data.ok && data.counselors) {
            counselorSelect.innerHTML = '<option value="ALL">All Counselors</option>';
            data.counselors.sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
                counselorSelect.add(new Option(`${c.name} (${c.employeeId})`, c.employeeId));
            });
            counselorSelect.disabled = false;
          }
        }).catch(() => statusEl.textContent = 'Error loading counselors.');
      });
      
      function validateControls() {
        btnRun.disabled = !centerSelect.value || !counselorSelect.value || !fromEl.value || !toEl.value;
      }
      
      [centerSelect, counselorSelect, fromEl, toEl].forEach(el => el.addEventListener('change', validateControls));

      function renderReport(report, employeeCodeFilter) {
          let totalAssigned = 0, totalActioned = 0;
          summaryKpisEl.innerHTML = ''; reportDetailsEl.innerHTML = '';
          var sortedDates = Object.keys(report).sort((a, b) => new Date(b) - new Date(a));
          
          if (sortedDates.length === 0) {
              summaryKpisEl.innerHTML = '<p>No data found for the selected criteria.</p>'; return;
          }

          sortedDates.forEach(function(date) {
              const allCounselorDataForDay = report[date] || {};
              let dailyData;

              if (employeeCodeFilter === 'ALL') {
                  dailyData = { assignedCount: 0, actionedCount: 0, dispositions: {} };
                  for (const empId in allCounselorDataForDay) {
                      dailyData.assignedCount += allCounselorDataForDay[empId].assignedCount;
                      dailyData.actionedCount += allCounselorDataForDay[empId].actionedCount;
                      for (const [action, count] of Object.entries(allCounselorDataForDay[empId].dispositions)) {
                          dailyData.dispositions[action] = (dailyData.dispositions[action] || 0) + count;
                      }
                  }
              } else {
                  dailyData = allCounselorDataForDay[employeeCodeFilter];
              }

              if (!dailyData || dailyData.assignedCount === 0 && dailyData.actionedCount === 0) return;

              // These are now calculated based on the accurate backend data
              dailyData.dueActionsCount = dailyData.assignedCount - dailyData.actionedCount;
              dailyData.completionPercentage = dailyData.assignedCount > 0 ? (dailyData.actionedCount / dailyData.assignedCount) * 100 : 0;
              
              totalAssigned += dailyData.assignedCount; 
              totalActioned += dailyData.actionedCount;

              let dispositionHtml = 'No actions taken.';
              if(Object.keys(dailyData.dispositions).length > 0) {
                  dispositionHtml = '<table class="disposition-table"><thead><tr><th>Disposition</th><th>Count</th></tr></thead><tbody>';
                  for(const [action, count] of Object.entries(dailyData.dispositions)) { dispositionHtml += `<tr><td>${action}</td><td>${count}</td></tr>`; }
                  dispositionHtml += '</tbody></table>';
              }
              const completionColor = dailyData.completionPercentage < 90 ? 'style="color:#c01e1e;"' : '';
              const dayCardHtml = `
                  <div class="day-card">
                      <div class="day-header">${new Date(date + 'T00:00:00').toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                      <div class="kpi-grid">
                          <div class="card"><div class="title">Assigned</div><div class="value">${dailyData.assignedCount}</div></div>
                          <div class="card"><div class="title">Actioned</div><div class="value">${dailyData.actionedCount}</div></div>
                          <div class="card"><div class="title">Due (Missed)</div><div class="value">${dailyData.dueActionsCount}</div></div>
                          <div class="card"><div class="title">Completion</div><div class="value" ${completionColor}>${dailyData.completionPercentage.toFixed(1)}%</div></div>
                      </div>
                      <h3 style="margin-top: 20px;">Dispositions</h3>
                      ${dispositionHtml}
                  </div>`;
              reportDetailsEl.innerHTML += dayCardHtml;
          });
          
          let totalDue = totalAssigned - totalActioned;
          const totalCompletion = totalAssigned > 0 ? (totalActioned / totalAssigned) * 100 : 0;
          const totalCompletionColor = totalCompletion < 90 ? 'style="color:#c01e1e;"' : '';
          summaryKpisEl.innerHTML = `
            <div class="card"><div class="title">Total Assigned</div><div class="value">${totalAssigned}</div></div>
            <div class="card"><div class="title">Total Actioned</div><div class="value">${totalActioned}</div></div>
            <div class="card"><div class="title">Total Due (Missed)</div><div class="value">${totalDue}</div></div>
            <div class="card"><div class="title">Completion Rate</div><div class="value" ${totalCompletionColor}>${totalCompletion.toFixed(1)}%</div></div>`;
      }
      
      btnRun.addEventListener('click', function() {
        var center = centerSelect.value; var employeeCode = counselorSelect.value;
        var from = fromEl.value; var to = toEl.value;
        counselorNameDisplay.textContent = `${center} - ${counselorSelect.options[counselorSelect.selectedIndex].text}`;
        // The backend parameter is just employeeCode, but we handle "ALL" now
        var url = `${API_BASE}?action=advancedreportv2&center=${encodeURIComponent(center)}&from=${from}&to=${to}&employeeCode=${encodeURIComponent(employeeCode)}`;
        fetchJson(url).then(data => {
            if (data.ok) { renderReport(data.report, employeeCode); statusEl.textContent = 'Report loaded!'; } 
            else { statusEl.textContent = `Error: ${data.error || 'Unknown error'}`; }
        }).catch(() => statusEl.textContent = 'Failed to fetch report.');
      });

      async function exportMasterData() {
        const from = fromEl.value;
        const to = toEl.value;
        if (!from || !to) { alert('Please select a valid date range first.'); return; }
        statusEl.textContent = 'Starting master export... This may take a while.';
        btnExportMaster.disabled = true;

        try {
            const counselorsData = {};
            const allDates = new Set(); 

            statusEl.textContent = 'Fetching all centers...';
            const centersResponse = await fetch(`${API_BASE}?action=getcenters`);
            const centersData = await centersResponse.json();
            if (!centersData.ok) throw new Error('Could not fetch centers.');

            for (const center of centersData.centers) {
                statusEl.textContent = `Fetching counselors for ${center}...`;
                const counselorsResponse = await fetch(`${API_BASE}?action=getcounselors&center=${encodeURIComponent(center)}`);
                const centerCounselorsData = await counselorsResponse.json();
                if (!centerCounselorsData.ok) continue;

                for (const counselor of centerCounselorsData.counselors) {
                    statusEl.textContent = `Fetching data for ${counselor.name} in ${center}...`;
                    const reportUrl = `${API_BASE}?action=advancedreportv2&center=${encodeURIComponent(center)}&from=${from}&to=${to}&employeeCode=${encodeURIComponent(counselor.employeeId)}`;
                    
                    try {
                        const reportResponse = await fetch(reportUrl);
                        const reportData = await reportResponse.json();

                        if (reportData.ok && reportData.report) {
                            const counselorKey = `${center}-${counselor.employeeId}`;
                            if (!counselorsData[counselorKey]) {
                                counselorsData[counselorKey] = { Center: center, 'Counsellor Name': counselor.name, 'Employee ID': counselor.employeeId, daily: {}, totalActioned: 0, totalAssigned: 0 };
                            }
                            for (const date in reportData.report) {
                                allDates.add(date);
                                // Correctly access the nested data for the specific employee
                                const day = reportData.report[date][counselor.employeeId];
                                if (day) {
                                    counselorsData[counselorKey].daily[date] = { Acted: day.actionedCount, Assigned: day.assignedCount };
                                    counselorsData[counselorKey].totalActioned += day.actionedCount;
                                    counselorsData[counselorKey].totalAssigned += day.assignedCount;
                                }
                            }
                        }
                    } catch (counselorError) {
                        console.error(`Skipping counselor ${counselor.name} due to an error:`, counselorError);
                        statusEl.textContent = `Skipping ${counselor.name}...`;
                    }
                }
            }

            statusEl.textContent = 'Data compiled. Generating HTML report...';
            const sortedDateRange = Array.from(allDates).sort();
            generateAndDownloadHtml(counselorsData, sortedDateRange);

        } catch (error) { statusEl.textContent = `Error during export: ${error.message}`; } 
        finally { btnExportMaster.disabled = false; statusEl.textContent = 'Master export complete!'; }
      }

      function generateAndDownloadHtml(data, dateRange) {
        const colorPalette = ['#FFFACD', '#F5F5F5', '#ADD8E6', '#F0FFF0', '#E6E6FA', '#FFF0F5', '#F0F8FF', '#FAEBD7'];
        const centerColors = {};
        let colorIndex = 0;
        
        let tableRows = '';
        const dailyTotals = dateRange.reduce((acc, date) => ({ ...acc, [date]: { Acted: 0, Assigned: 0 } }), {});

        const sortedData = Object.values(data).sort((a, b) => {
            if (a.Center < b.Center) return -1;
            if (a.Center > b.Center) return 1;
            return a['Counsellor Name'].localeCompare(b['Counsellor Name']);
        });

        sortedData.forEach(counselor => {
            if (!centerColors[counselor.Center]) {
                centerColors[counselor.Center] = colorPalette[colorIndex % colorPalette.length];
                colorIndex++;
            }
            const rowColor = centerColors[counselor.Center];

            let rowHtml = `<tr style="background-color:${rowColor};"><td><b>${counselor.Center}</b></td><td>${counselor['Counsellor Name']}</td><td>${counselor['Employee ID']}</td>`;
            dateRange.forEach(date => {
                const dayData = counselor.daily[date];
                const acted = dayData ? dayData.Acted : 0;
                const assigned = dayData ? dayData.Assigned : 0;
                rowHtml += `<td>${assigned}</td><td>${acted}</td>`;
                dailyTotals[date].Acted += acted;
                dailyTotals[date].Assigned += assigned;
            });
            const completion = counselor.totalAssigned > 0 ? (counselor.totalActioned / counselor.totalAssigned) * 100 : 0;
            const remarks = completion < 90 ? 'Review Needed' : 'OK';
            rowHtml += `<td>${completion.toFixed(1)}%</td><td>${remarks}</td></tr>`;
            tableRows += rowHtml;
        });

        let totalRowHtml = '<tr class="total-row"><td></td><td colspan="2">Total</td>';
        dateRange.forEach(date => {
            totalRowHtml += `<td>${dailyTotals[date].Assigned}</td><td>${dailyTotals[date].Acted}</td>`;
        });
        totalRowHtml += '<td colspan="2"></td></tr>';

        const htmlContent = `
            <!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Master KPI Report</title>
                <style>
                    body{font-family:'Poppins',sans-serif}
                    table{border-collapse:collapse;width:100%;font-size:12px}
                    th,td{border:1px solid #a9a9a9;padding:6px 8px;text-align:center}
                    .header-main{background-color:#fce5cd;font-weight:700}
                    .header-sub{background-color:#0070c0;color:#fff;font-weight:700}
                    .total-row{background-color:#d9d9d9;font-weight:700}
                    #exportBtn{padding:8px 12px;font-family:'Poppins',sans-serif;margin:0 0 15px 0;cursor:pointer;background:#1D6F42;color:#fff;border:none;border-radius:5px}
                </style>
            </head><body>
                <h1>Master KPI Report (${fromEl.value} to ${toEl.value})</h1>
                <button id="exportBtn">Export to CSV</button>
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th class="header-main" rowspan="2">Center</th><th class="header-main" rowspan="2">Counsellor Name</th><th class="header-main" rowspan="2">Employee ID</th>
                            ${dateRange.map(date => `<th class="header-sub" colspan="2">${new Date(date + 'T00:00:00').toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</th>`).join('')}
                            <th class="header-sub" colspan="2">Overview</th>
                        </tr>
                        <tr>
                            ${dateRange.map(() => '<th class="header-main">Assigned</th><th class="header-main">Acted Leads</th>').join('')}
                            <th class="header-main">Completion %</th><th class="header-main">Remarks</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}${totalRowHtml}</tbody>
                </table>
                <script>
                    function downloadCsv() {
                        const table = document.getElementById('reportTable');
                        let csvContent = [];
                        const header1 = [];
                        table.rows[0].querySelectorAll('th').forEach(th => {
                            header1.push(\`"\${th.textContent.trim()}"\`);
                            const colspan = parseInt(th.getAttribute('colspan') || 1);
                            for (let i = 1; i < colspan; i++) header1.push('');
                        });
                        csvContent.push(header1.join(','));
                        const header2 = [];
                        let rowspanOffset = 0;
                        table.rows[0].querySelectorAll('th[rowspan="2"]').forEach(() => rowspanOffset++);
                        for (let i = 0; i < rowspanOffset; i++) header2.push('');
                        table.rows[1].querySelectorAll('th').forEach(th => header2.push(\`"\${th.textContent.trim()}"\`));
                        csvContent.push(header2.join(','));
                        for (let i = 2; i < table.rows.length; i++) {
                            const rowData = [];
                            table.rows[i].querySelectorAll('td').forEach(td => {
                                rowData.push(\`"\${td.textContent.trim().replace(/"/g, '""')}"\`);
                                const colspan = parseInt(td.getAttribute('colspan') || 1);
                                for (let j = 1; j < colspan; j++) rowData.push('');
                            });
                            csvContent.push(rowData.join(','));
                        }
                        const blob = new Blob([csvContent.join('\\n')], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = 'Master_Report_From_HTML.csv';
                        link.click();
                        URL.revokeObjectURL(link.href);
                    }
                    document.getElementById('exportBtn').addEventListener('click', downloadCsv);
                <\/script>
            </body></html>`;
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Styled_Master_Report_${fromEl.value}_to_${toEl.value}.html`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      }

      btnExportMaster.addEventListener('click', exportMasterData);

      const minDate = '2025-09-21';
      fromEl.min = minDate;
      toEl.min = minDate;
      
      const today = new Date();
      const todayStr = today.toISOString().slice(0, 10);
      
      fromEl.value = minDate;
      toEl.value = todayStr;
      
      populateCenters();

    })();
  </script>
</body>
</html>
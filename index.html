<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Master KPI Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { margin:0; font-family:'Poppins', sans-serif; background:#f4f7f6; color: #333; }
    .header { background:#4b0082; color: white; padding:15px 30px; font-weight:700; font-size: 1.2rem; display:flex; justify-content:space-between; align-items: center; }
    .wrap { padding:20px; max-width:1600px; margin:0 auto; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:20px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .controls select, .controls input { padding:10px; border:1px solid #ccc; border-radius:6px; font-family:'Poppins', sans-serif; background: #fff; }
    .btn { padding:10px 18px; background:#e62222; color:#fff; border:none; font-weight:700; cursor:pointer; border-radius: 6px; transition: background 0.2s; }
    .btn:hover { background: #c01e1e; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .kpi-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; }
    .card { background:#fff; border-radius:8px; padding:20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .card .title { font-size: 1rem; color: #555; margin-bottom: 10px; }
    .card .value { font-size: 2.5rem; font-weight: 700; color: #4b0082; }
    .card .subtext { font-size: 0.8rem; color: #777; margin-top:5px;}
    h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 40px; color: #4b0082;}
    .status { font-weight: 600; margin-left: 15px; }
    #reportDetails { margin-top: 20px; }
    .day-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-bottom: 15px; }
    .day-header { font-weight: 700; font-size: 1.2rem; margin-bottom: 10px; }
    .disposition-table { width: 100%; border-collapse: collapse; margin-top:10px; }
    .disposition-table th, .disposition-table td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <div class="header">
    <div>Admin - Master KPI Tracker</div>
    <div id="counselorNameDisplay"></div>
  </div>
  <div class="wrap">
    <div class="controls">
      <select id="centerSelect" required><option value="">Select Center...</option></select>
      <select id="counselorSelect" required><option value="">Select Counselor...</option></select>
      <input type="date" id="from" />
      <input type="date" id="to" />
      <button class="btn" id="btnRun" disabled>Run Report</button>
      <div id="status" class="status"></div>
    </div>

    <h2>High-Level Summary</h2>
    <div class="kpi-grid" id="summary-kpis">
      </div>

    <h2 id="details-header">Daily Breakup</h2>
    <div id="reportDetails"></div>
  </div>

  <script>
    (function(){
      // *** THIS IS THE UPDATED API URL ***
      var API_BASE = 'https://script.google.com/macros/s/AKfycbxTHX4RNFV41cbFX8o6ataVhtVS13kiSiDS4uWizNeuZ3RKEOXpMBYivTWhYtvtiXg1sA/exec';

      var centerSelect = document.getElementById('centerSelect');
      var counselorSelect = document.getElementById('counselorSelect');
      var fromEl = document.getElementById('from');
      var toEl = document.getElementById('to');
      var btnRun = document.getElementById('btnRun');
      var statusEl = document.getElementById('status');
      var reportDetailsEl = document.getElementById('reportDetails');
      var summaryKpisEl = document.getElementById('summary-kpis');
      var counselorNameDisplay = document.getElementById('counselorNameDisplay');

      function fetchJson(url) {
        statusEl.textContent = 'Loading...';
        btnRun.disabled = true;
        return fetch(url).then(r => r.json()).finally(() => {
          statusEl.textContent = '';
          btnRun.disabled = false;
        });
      }

      function populateCenters() {
        // Uses the getcenters endpoint from your main script
        fetchJson(API_BASE + '?action=getcenters').then(data => {
          if (data.ok && data.centers) {
            centerSelect.innerHTML = '<option value="">Select Center...</option>';
            data.centers.sort().forEach(center => centerSelect.add(new Option(center, center)));
          }
        }).catch(() => statusEl.textContent = 'Error loading centers.');
      }

      centerSelect.addEventListener('change', function() {
        var center = this.value;
        counselorSelect.innerHTML = '<option value="">Loading Counselors...</option>';
        if (!center) {
          counselorSelect.innerHTML = '<option value="">Select Counselor...</option>';
          return;
        }
        // Uses the getcounselors endpoint from your main script
        fetchJson(`${API_BASE}?action=getcounselors&center=${encodeURIComponent(center)}`).then(data => {
          if (data.ok && data.counselors) {
            counselorSelect.innerHTML = '<option value="ALL">All Counselors</option>';
            data.counselors.forEach(c => counselorSelect.add(new Option(`${c.name} (${c.employeeId})`, c.employeeId)));
          }
        }).catch(() => statusEl.textContent = 'Error loading counselors.');
      });

      function renderReport(report) {
          let totalAssigned = 0, totalActioned = 0, totalDue = 0;
          summaryKpisEl.innerHTML = '';
          reportDetailsEl.innerHTML = '';

          var sortedDates = Object.keys(report).sort((a, b) => new Date(b) - new Date(a));

          if (sortedDates.length === 0) {
              summaryKpisEl.innerHTML = '<p>No data found for this period.</p>';
              reportDetailsEl.innerHTML = '';
              return;
          }

          sortedDates.forEach(function(date) {
              const dayData = report[date];
              totalAssigned += dayData.assignedCount;
              totalActioned += dayData.actionedCount;
              totalDue += dayData.dueActionsCount;

              let dispositionHtml = 'No actions taken.';
              if(Object.keys(dayData.dispositions).length > 0) {
                  dispositionHtml = '<table class="disposition-table"><thead><tr><th>Disposition</th><th>Count</th></tr></thead><tbody>';
                  for(const [action, count] of Object.entries(dayData.dispositions)) {
                      dispositionHtml += `<tr><td>${action}</td><td>${count}</td></tr>`;
                  }
                  dispositionHtml += '</tbody></table>';
              }

              const dayCardHtml = `
                  <div class="day-card">
                      <div class="day-header">${new Date(date + 'T00:00:00').toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                      <div class="kpi-grid">
                          <div class="card"><div class="title">Assigned</div><div class="value">${dayData.assignedCount}</div></div>
                          <div class="card"><div class="title">Actioned</div><div class="value">${dayData.actionedCount}</div></div>
                          <div class="card"><div class="title">Due (Missed)</div><div class="value">${dayData.dueActionsCount}</div></div>
                          <div class="card"><div class="title">Completion</div><div class="value">${dayData.completionPercentage.toFixed(1)}%</div></div>
                      </div>
                      <h3 style="margin-top: 20px;">Dispositions</h3>
                      ${dispositionHtml}
                  </div>
              `;
              reportDetailsEl.innerHTML += dayCardHtml;
          });
          
          const totalCompletion = totalAssigned > 0 ? ((totalActioned / totalAssigned) * 100).toFixed(1) + '%' : '0.0%';
          summaryKpisEl.innerHTML = `
            <div class="card"><div class="title">Total Assigned</div><div class="value">${totalAssigned}</div><div class="subtext">Leads needing action in period</div></div>
            <div class="card"><div class="title">Total Actioned</div><div class="value">${totalActioned}</div><div class="subtext">Unique leads contacted</div></div>
            <div class="card"><div class="title">Total Due (Missed)</div><div class="value">${totalDue}</div><div class="subtext">Assigned but not actioned</div></div>
            <div class="card"><div class="title">Completion Rate</div><div class="value">${totalCompletion}</div><div class="subtext">Actioned / Assigned</div></div>
          `;
      }
      
      btnRun.addEventListener('click', function() {
        var center = centerSelect.value;
        var employeeCode = counselorSelect.value;
        var from = fromEl.value;
        var to = toEl.value;
        
        if (!center || !employeeCode || !from || !to) {
            statusEl.textContent = 'Please fill all fields.';
            return;
        }

        counselorNameDisplay.textContent = `${center} - ${counselorSelect.options[counselorSelect.selectedIndex].text}`;
        var url = `${API_BASE}?action=advancedreportv2&center=${encodeURIComponent(center)}&from=${from}&to=${to}&employeeCode=${encodeURIComponent(employeeCode)}`;
        
        fetchJson(url).then(data => {
            if (data.ok) {
                renderReport(data.report);
                statusEl.textContent = 'Report loaded successfully!';
            } else {
                statusEl.textContent = `Error: ${data.error || 'Unknown error'}`;
            }
        }).catch(() => statusEl.textContent = 'Failed to fetch report.');
      });

      // Initialize page
      var toDate = new Date();
      var fromDate = new Date();
      fromDate.setDate(toDate.getDate() - 6);
      toEl.value = toDate.toISOString().slice(0,10);
      fromEl.value = fromDate.toISOString().slice(0,10);
      populateCenters();

    })();
  </script>
</body>
</html>
